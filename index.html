<!--
LBM (Leaflet Blog Manager)
Version: 0.5
License: MIT
applchu wuz here
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Metadata -->
    <title id="dynamic-title">LBM System</title>
    <meta id="dynamic-desc" name="description" content="A personal microblogging archive.">
    <!-- RSS -->
    <link id="dynamic-rss" rel="alternate" type="application/rss+xml" title="RSS Feed" href="rss.xml">
    
    <!-- CSP -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; img-src * data: blob:; media-src * data: blob:; connect-src * 'unsafe-inline';">
    
    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="style.css">
    
    <style>
        #bridge-frame { width: 1px; height: 1px; opacity: 0; position: absolute; pointer-events: none; }
        
        /* Post Highlight Animation */
        .highlight-post { animation: highlightFade 2s ease-out; border: 1px solid var(--accent-color); }
        @keyframes highlightFade { 0% { box-shadow: 0 0 15px var(--accent-color); } 100% { box-shadow: none; } }
    </style>
</head>

<body>

    <!-- Notifications -->
    <div id="toast-container"></div>

    <!-- Upload Modal -->
    <div id="upload-modal">
        <div class="upload-box">
            <h3 style="color:var(--accent-color); margin-bottom:10px; font-family: var(--font-display); letter-spacing: 2px;">SYSTEM SYNC</h3>
            <p id="upload-status-text" style="color:#aaa; font-size:12px; font-family: var(--font-mono);">Initiating upload sequence...</p>
            <div class="progress-container">
                <div id="upload-progress-bar" class="progress-fill"></div>
            </div>
            <div id="upload-error-log" class="error-details"></div>
            <button id="upload-close-btn" class="action-btn" style="margin-top:15px; display:none;" onclick="hideUploadModal()">Close</button>
        </div>
    </div>

    <!-- Token Repair Modal -->
    <div id="repair-modal">
        <div class="upload-box">
            <h3 style="color:var(--dislike-color); margin-bottom:10px; font-family: var(--font-display);">CONNECTION REPAIR</h3>
            <p style="color:#aaa; font-size:12px; margin-bottom:15px; font-family: var(--font-mono);">Your Secure Token was rejected. Please re-authenticate.</p>
            <form onsubmit="runRepair(); return false;">
                <input type="text" name="username" autocomplete="username" style="display:none;">
                <input type="password" id="repair-api-key" class="setup-input" placeholder="Neocities API Key" style="margin-bottom:15px;" autocomplete="new-password">
                <button class="action-btn" type="submit">Generate New Token & Sync</button>
            </form>
            <button class="action-btn" onclick="document.getElementById('repair-modal').style.display='none'" style="background:transparent; border:none; margin-top:10px; color:#888;">Cancel</button>
        </div>
    </div>

    <!-- Setup Wizard -->
    <div id="setup-overlay" style="display:none;">
        <div class="setup-box">
            <h1 style="color:var(--accent-color); margin-bottom:20px; text-align:center;">SYSTEM BOOT // INITIAL SETUP</h1>
            <h3 style="margin-bottom:10px;">1. System Configuration</h3>
            <p style="font-size:11px; color:#aaa; margin-bottom:10px; font-family: var(--font-mono);">Create credentials. These will be encrypted into a Secure Token.</p>
            <form onsubmit="return false;">
                <input type="text" name="username" autocomplete="username" style="display:none;">
                <label style="font-size:11px; color:#aaa; margin-top:10px; font-family: var(--font-mono);">Create Admin Password:</label>
                <input type="password" id="setup-password" class="setup-input" placeholder="Password" autocomplete="new-password">
                <label style="font-size:11px; color:#aaa; margin-top:10px; display:block; font-family: var(--font-mono);">Neocities API Key:</label>
                <input type="password" id="setup-neocities-key" class="setup-input" placeholder="API Key (Will be encrypted)" autocomplete="off">
            </form>

            <h3 style="margin: 20px 0 10px 0;">2. Branding</h3>
            <div class="config-grid">
                <div class="config-item"><label>Site Name</label><input type="text" id="setup-site-name" class="setup-input" value="LBM // System" oninput="updateSetupPreview()"></div>
                <div class="config-item"><label>Tagline</label><input type="text" id="setup-tagline" class="setup-input" value="Personal Archive" oninput="updateSetupPreview()"></div>
                <div class="config-item"><label>Leaflets Tab</label><input type="text" id="setup-leaflets-name" class="setup-input" value="Leaflets" oninput="updateSetupPreview()"></div>
                <div class="config-item"><label>Copyright</label><input type="text" id="setup-copyright" class="setup-input" value="2025 LBM" oninput="updateSetupPreview()"></div>
            </div>
            <div class="config-item" style="margin-bottom:10px;"><label>Profile Picture URL</label><input type="text" id="setup-pfp-image" class="setup-input" placeholder="https://..." oninput="updateSetupPreview()"></div>
            <div class="config-item" style="margin-bottom:10px;"><label>Header Banner URL</label><input type="text" id="setup-banner-image" class="setup-input" placeholder="https://..." oninput="updateSetupPreview()"></div>

            <h3 style="margin: 20px 0 10px 0;">3. Theme</h3>
            <div class="config-grid">
                <div class="config-item"><label>Background</label><input type="color" id="col-bg" class="color-picker" value="#010101" oninput="updateSetupPreview()"></div>
                <div class="config-item"><label>Text</label><input type="color" id="col-text" class="color-picker" value="#e0f2f1" oninput="updateSetupPreview()"></div>
                <div class="config-item"><label>Sidebar/Footer</label><input type="color" id="col-sidebar" class="color-picker" value="#0a0a0a" oninput="updateSetupPreview()"></div>
                <div class="config-item"><label>Accent</label><input type="color" id="col-accent" class="color-picker" value="#ff6b35" oninput="updateSetupPreview()"></div>
                <div class="config-item"><label>Post Bg</label><input type="color" id="col-leaflet" class="color-picker" value="#0a0a0a" oninput="updateSetupPreview()"></div>
                <div class="config-item"><label>Borders</label><input type="color" id="col-border" class="color-picker" value="#1f2937" oninput="updateSetupPreview()"></div>
                <div class="config-item"><label>Active Nav</label><input type="color" id="col-nav-active" class="color-picker" value="#c8ff00" oninput="updateSetupPreview()"></div>
            </div>

            <h4 style="margin: 10px 0 5px 0; color: #aaa; border-bottom: 1px dotted #555; font-family: var(--font-mono);">Interaction Settings</h4>
            <div class="config-grid">
                <div class="config-item">
                    <label>Enable Reactions?</label>
                    <select id="setup-reactions-enabled" class="setup-input" onchange="updateSetupPreview()">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>Icon Style</label>
                    <select id="setup-reaction-icon" class="setup-input" onchange="updateSetupPreview()">
                        <option value="face">Faces (^_^)</option>
                        <option value="thumb">Thumbs üëç</option>
                        <option value="arrow">Arrows ‚¨Ü</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>Like Label</label>
                    <input type="text" id="setup-like-label" class="setup-input" value="(Ôºæ‚àáÔºæ)" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Dislike Label</label>
                    <input type="text" id="setup-dislike-label" class="setup-input" value="(Ôºõ„Å∏Ôºö)" oninput="updateSetupPreview()">
                </div>
            </div>
            <div class="config-grid">
                <div class="config-item">
                    <label>Like Color</label>
                    <input type="color" id="col-like" class="color-picker" value="#c8ff00" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Dislike Color</label>
                    <input type="color" id="col-dislike" class="color-picker" value="#ff3c8e" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Like Button Text</label>
                    <input type="color" id="col-like-btn" class="color-picker" value="#010101" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Dislike Button Text</label>
                    <input type="color" id="col-dislike-btn" class="color-picker" value="#010101" oninput="updateSetupPreview()">
                </div>
            </div>

            <div class="config-item" style="margin-bottom:10px;">
                <label>Widget Padding</label>
                <input type="text" id="setup-widget-padding" class="setup-input" value="1.5rem" oninput="updateSetupPreview()">
            </div>

            <div class="config-item" style="margin-bottom:10px;">
                <label>Global Background Image (Optional)</label>
                <input type="text" id="setup-bg-image" class="setup-input" placeholder="https://..." oninput="updateSetupPreview()">
            </div>

            <div class="config-item">
                <label>Allow Comments?</label>
                <select id="setup-comments" class="setup-input" onchange="updateSetupPreview()">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>

            <div class="config-item" style="margin-bottom:15px;">
                <label>Custom CSS</label>
                <textarea id="setup-custom-css" class="setup-input" rows="4" placeholder="body { font-family: 'Arial'; }" oninput="updateSetupPreview()"></textarea>
            </div>

            <button class="action-btn" onclick="generateConfigFile('setup')" style="margin-top:20px;">ENCRYPT KEY & GENERATE system.js</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-overlay" style="display:none;">
        <div class="setup-box">
            <h1 style="color:var(--accent-color); margin-bottom:20px; text-align:center;">EDIT LEAFLET</h1>
            
            <textarea id="edit-post-content" rows="6" placeholder="Content (HTML & Markdown supported)" class="setup-input"></textarea>
            
            <label style="font-size:11px; color:#aaa; margin-top:5px; font-family: var(--font-mono);">Media Path(s)</label>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="text" id="edit-add-media-input" placeholder="Add URL..." class="setup-input" style="margin-bottom:0;">
                <button class="action-btn" style="width:auto;" onclick="addUrlToQueue('edit')">Add</button>
            </div>
            <div id="edit-media-queue" class="media-queue"></div>
            <input type="hidden" id="edit-post-media">
            
            <label style="font-size:11px; color:#aaa; margin-top:5px; font-family: var(--font-mono);">Tags</label>
            <input type="text" id="edit-post-tags" placeholder="art, news" class="setup-input">
            
            <div class="form-group" style="margin: 15px 0;">
                <input type="checkbox" id="edit-post-pin" style="vertical-align: middle;">
                <label for="edit-post-pin" style="color:#aaa; font-size:12px; font-family: var(--font-mono); vertical-align: middle; margin-left: 5px;">Pin to Top</label>
            </div>
            
            <input type="hidden" id="edit-post-id">
            
            <div style="display:flex; gap:10px;">
                <button class="action-btn" onclick="submitEditedPost()">Save Changes</button>
                <button class="action-btn" onclick="closeEditModal()" style="background:var(--dislike-color);">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Layout -->
    <div class="container">
        <header id="site-header-block">
            <div class="header-overlay">
                <div class="header-row">
                    <div class="header-identity">
                        <!-- Navigation Toggle -->
                        <button id="hamburger-btn" onclick="toggleMobileMenu()">&#9776;</button>
                        
                        <img id="header-pfp" class="site-pfp" alt="PFP">
                        <div class="header-titles">
                            <h1 id="header-site-name">Loading...</h1>
                            <div id="header-tagline" class="site-tagline"></div>
                        </div>
                    </div>
                    <div id="db-status">Booting...</div>
                </div>
            </div>
        </header>

        <!-- Marquee -->
        <div class="marquee-container">
            <div class="marquee" id="marquee-content">
                <!-- Add your own scrolling text here -->
                <span>LEAFLET</span>
                <span>BLOG</span>
                <span>MANAGER</span>
                <span>LEAFLET</span>
                <span>BLOG</span>
                <span>MANAGER</span>
                <span>LEAFLET</span>
                <span>BLOG</span>
                <span>MANAGER</span>
                <span>LEAFLET</span>
                <span>BLOG</span>
                <span>MANAGER</span>
            </div>
        </div>

        <div class="layout-wrapper">
            <!-- Sidebar -->
            <nav class="sidebar" id="main-sidebar">
                <button id="mobile-close-btn" onclick="toggleMobileMenu()">&times; Close</button>

                <button class="nav-btn active" onclick="switchTab('leaflets')" id="nav-leaflets-btn">Leaflets</button>
                <button class="nav-btn" onclick="switchTab('gallery')">Gallery</button>
                
                <!-- Tag Cloud -->
                <div id="tag-cloud-container">
                    <!-- Tags will appear here -->
                </div>
                
                <div style="height: 10px;"></div>
                <button class="nav-btn" id="admin-tab-btn" onclick="switchTab('admin')" style="color: var(--gray); border-color: transparent;">Login</button>
				<a href="rss.xml" class="nav-btn" target="_blank" style="color: var(--accent-color); border-color: transparent; text-decoration: none; display: block; margin-top: 5px;">
                    ‚¨á RSS Feed
                </a>
            </nav>
            
            <!-- Mobile Overlay for Sidebar -->
            <div id="sidebar-overlay" onclick="toggleMobileMenu()"></div>

            <main>
                <!-- Feed Tab -->
                <section id="tab-leaflets" class="view-section active">
                    <div class="feed-header">
                        <h2 id="header-leaflets-title">Recent Updates</h2>
                        <button id="clear-filter-btn" class="action-btn" style="display:none; width:auto; padding: 5px 10px; font-size: 0.7rem;" onclick="clearFilters()">Clear Filter</button>
                    </div>
                    <!-- Search Box -->
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="//search..." oninput="handleSearch(this.value)">
                        <select id="sort-filter" onchange="renderLeaflets()" class="sort-dropdown">
                            <option value="newest">Newest</option>
                            <option value="oldest">Oldest</option>
                            <option value="popular">Popular (Likes)</option>
                            <option value="controversial">Controversial (Dislikes)</option>
                        </select>
                    </div>
                    <div id="leaflets-container">Loading content...</div>
                </section>

                <!-- Gallery Tab -->
                <section id="tab-gallery" class="view-section">
                    <h2>Image Gallery</h2>
                    <div id="gallery-container" class="gallery-grid">Loading...</div>
                </section>

                <!-- Admin Tab -->
                <section id="tab-admin" class="view-section">
                    <h2>Admin // Login</h2>
                    <div id="admin-login-form" class="admin-panel">
                        <p style="margin-bottom:15px; color:#aaa; font-family: var(--font-mono);">Enter your admin password.</p>
                        <form onsubmit="adminLogin(); return false;">
                            <input type="text" name="username" autocomplete="username" style="display:none;">
                            <input type="password" id="login-pass" class="setup-input" placeholder="Password" style="margin-bottom:10px;" autocomplete="current-password">
                            <button class="action-btn" type="submit">Access System</button>
                        </form>
                    </div>

                    <div id="admin-dashboard" style="display:none;">
                        <div class="sync-status">
                            <div id="sync-dot" class="sync-indicator synced"></div>
                            <span id="sync-text">System Synced</span>
                            <div style="margin-left: auto; display:flex; gap:5px;">
                                <button onclick="forceSyncAll()" class="reaction-btn" style="color:var(--accent-color); border-color:var(--accent-color);">FORCE SYNC</button>
                                <button onclick="downloadBackup()" class="reaction-btn" title="Download Backup">‚¨á JS</button>
                                <button onclick="downloadStaticIndex()" class="reaction-btn" title="Download Static HTML for SEO" style="border-color:#aaa;">‚¨á HTML</button>
                                <button onclick="downloadRSS()" class="reaction-btn" title="Download RSS Feed" style="border-color:#ff9f43; color:#ff9f43;">‚¨á RSS</button>
                            </div>
                        </div>

                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <button class="action-btn" onclick="switchAdminSubTab('post')" style="flex:1;">New Post</button>
                            <button class="action-btn" onclick="switchAdminSubTab('settings')" style="flex:1; background:var(--bg-dark); color: var(--text-color);">Site Settings</button>
                            <button class="action-btn" onclick="location.reload()" style="flex:0; background:var(--dislike-color);">Logout</button>
                        </div>

                        <!-- Post Editor -->
                        <div id="admin-sub-post" class="admin-panel">
                            <h3>Create New Content</h3>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <textarea id="admin-content" rows="4" placeholder="What's on your mind? (Markdown & HTML supported)" class="setup-input"></textarea>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="color:var(--accent-color); display:block; margin-bottom:5px; font-family: var(--font-mono); font-size: 0.7rem;">Media Upload (Will upload to img/)</label>
                                <div class="file-upload-wrapper" style="font-family: var(--font-mono); font-size: 0.8rem;">
                                    <input type="file" id="file-selector" onchange="handleFileSelect()" accept="image/*,video/*" multiple>
                                    <div id="upload-file-info" style="display:none; margin-left:10px; font-size:11px; color:var(--accent-color);"></div>
                                    
                                    <!-- New Media Queue -->
                                    <div id="admin-media-queue" class="media-queue"></div>
                                </div>
                            </div>
                            
                            <!-- Add URL Input -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="color:var(--accent-color); display:block; margin-bottom:5px; font-family: var(--font-mono); font-size: 0.7rem;">Add External URL</label>
                                <div style="display:flex; gap:5px;">
                                    <input type="text" id="admin-media-input" placeholder="https://..." class="setup-input" style="margin-bottom:0;">
                                    <button class="action-btn" style="width:auto;" onclick="addUrlToQueue('admin')">Add</button>
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 15px;">
                                <input type="text" id="admin-tags" placeholder="Tags (comma separated: art, news, daily)" class="setup-input">
                            </div>
                            <!-- Pin Toggle -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <input type="checkbox" id="admin-pin" style="vertical-align: middle;">
                                <label for="admin-pin" style="color:#aaa; font-size:12px; font-family: var(--font-mono); vertical-align: middle; margin-left: 5px;">Pin to Top</label>
                            </div>
                            <button class="action-btn" onclick="addPost()">Post & Sync</button>
                        </div>

                        <!-- Site Settings -->
                        <div id="admin-sub-settings" class="admin-panel" style="display:none;">
                            <h3>SEO & Metadata</h3>
                            <div class="config-grid">
                                <div class="config-item"><label>Window Title</label><input type="text" id="edit-window-title" class="setup-input" placeholder="My Blog" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Meta Description</label><input type="text" id="edit-meta-desc" class="setup-input" placeholder="A brief description..." oninput="updateLivePreview()"></div>
                            </div>

                            <h3 style="margin-top:15px;">Visual Customization</h3>
                            <div class="config-grid">
                                <div class="config-item"><label>Site Name</label><input type="text" id="edit-site-name" class="setup-input" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Tagline</label><input type="text" id="edit-tagline" class="setup-input" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Leaflets Name</label><input type="text" id="edit-leaflets-name" class="setup-input" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Copyright</label><input type="text" id="edit-copyright" class="setup-input" oninput="updateLivePreview()"></div>
                            </div>
                            <div class="config-grid">
                                <div class="config-item"><label>PFP URL</label><input type="text" id="edit-pfp-image" class="setup-input" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Banner URL</label><input type="text" id="edit-banner-image" class="setup-input" oninput="updateLivePreview()"></div>
                            </div>

                            <h4>Colors & Theme</h4>
                            <div class="config-grid">
                                <div class="config-item"><label>Bg</label><input type="color" id="edit-col-bg" class="color-picker" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Text</label><input type="color" id="edit-col-text" class="color-picker" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Sidebar</label><input type="color" id="edit-col-sidebar" class="color-picker" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Accent</label><input type="color" id="edit-col-accent" class="color-picker" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Post Bg</label><input type="color" id="edit-col-leaflet" class="color-picker" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Borders</label><input type="color" id="edit-col-border" class="color-picker" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Active Nav</label><input type="color" id="edit-col-nav-active" class="color-picker" oninput="updateLivePreview()"></div>
                            </div>
                            
                            <!-- Reset -->
                            <button class="action-btn" style="background:var(--border-color); color:var(--text-color); margin-top:10px; margin-bottom:20px;" onclick="resetColors()">Reset Colors to Default</button>

                            <h4>Interaction Settings</h4>
                            <div class="config-grid">
                                <div class="config-item">
                                    <label>Enable?</label>
                                    <select id="edit-reactions-enabled" class="setup-input" onchange="updateLivePreview()">
                                        <option value="true">Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="config-item">
                                    <label>Icon Style</label>
                                    <select id="edit-reaction-icon" class="setup-input" onchange="updateLivePreview()">
                                        <option value="face">Faces</option>
                                        <option value="thumb">Thumbs</option>
                                        <option value="arrow">Arrows</option>
                                    </select>
                                </div>
                                <div class="config-item"><label>Like Label</label><input type="text" id="edit-like-label" class="setup-input" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Dislike Label</label><input type="text" id="edit-dislike-label" class="setup-input" oninput="updateLivePreview()"></div>
                            </div>
                            <div class="config-grid">
                                <div class="config-item"><label>Like Color</label><input type="color" id="edit-col-like" class="color-picker" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Dislike Color</label><input type="color" id="edit-col-dislike" class="color-picker" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Like Text</label><input type="color" id="edit-col-like-btn" class="color-picker" oninput="updateLivePreview()"></div>
                                <div class="config-item"><label>Dislike Text</label><input type="color" id="edit-col-dislike-btn" class="color-picker" oninput="updateLivePreview()"></div>
                            </div>
                            
                            <div class="config-item" style="margin-bottom:15px;"><label>Widget Padding</label><input type="text" id="edit-widget-padding" class="setup-input" oninput="updateLivePreview()"></div>
                            <div class="config-item" style="margin-bottom:15px;"><label>Global Background Image</label><input type="text" id="edit-bg-image" class="setup-input" oninput="updateLivePreview()"></div>
                            <div class="config-item" style="margin-bottom:15px;">
                                <label>Comments</label>
                                <select id="edit-comments" class="setup-input" onchange="updateLivePreview()">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <!-- Token Rotation -->
                            <div class="config-item" style="margin-bottom:15px; border-top:1px dotted #555; padding-top:15px;">
                                <label>Update API Key (Optional)</label>
                                <form onsubmit="return false;">
                                    <input type="text" name="username" autocomplete="username" style="display:none;">
                                    <input type="password" id="edit-neocities-key" class="setup-input" placeholder="Enter new key to rotate token" autocomplete="new-password">
                                </form>
                            </div>

                            <div class="config-item" style="margin-bottom:15px;">
                                <label>Custom CSS</label>
                                <textarea id="edit-custom-css" class="setup-input" rows="6" oninput="updateLivePreview()"></textarea>
                            </div>
                            
                            <!-- Token Status -->
                            <div style="font-size:10px; color:#555; text-align:center; margin-top:10px;">Auth Token Loaded</div>

                            <button class="action-btn" onclick="saveSystem()">Save Settings & Sync</button>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <footer>
        <div id="footer-text">
            &copy; 2025 LBM
        </div>
    </footer>

    <!-- Lightbox -->
    <div id="leaflet-lightbox" class="lightbox" onclick="if(event.target === this) closeLightbox()">
        <div class="lightbox-content">
            <span class="close-btn" onclick="closeLightbox()">&times;</span>
            <div id="lightbox-body"></div>
        </div>
    </div>

    <!-- Media Viewer -->
    <div id="media-fullscreen-overlay" class="media-overlay" onclick="closeMediaViewer()">
        <span class="close-media-btn" onclick="closeMediaViewer()">&times;</span>
        <div id="media-content-wrapper" onclick="event.stopPropagation()"></div>
    </div>

    <!-- Application Logic -->
    <script>
        // Constants
        const FIXED_BRIDGE_URL = "https://applchu.link/lbm/0.4/bridge.html?v=" + new Date().getTime();
        const LOCAL_STORAGE_KEY = "LBM_CONFIG_CACHE";
        const LOCAL_REACTIONS_KEY = "LBM_USER_REACTIONS";
        
        // Theme Defaults
        const DEFAULT_THEME_COLORS = {
            bg: "#010101", text: "#e0f2f1", sidebar: "#0a0a0a", accent: "#ff6b35",
            leaflet: "#0a0a0a", border: "#1f2937", navActive: "#c8ff00",
            like: "#c8ff00", dislike: "#ff3c8e",
            likeBtn: "#010101", dislikeBtn: "#010101"
        };
        
        // Utilities
        function unicodeToBase64(str) { return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1))); }
        function base64ToUnicode(str) { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); }
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function downloadFile(content, name) {
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([content], { type: "text/plain" }));
            link.download = name;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        
        window.downloadBackup = async function() { 
            await generateConfigFile('edit'); 
        };

        function showToast(msg, type='info') {
            const t = document.createElement('div'); t.className=`toast ${type}`; 
            t.innerHTML = type==='loading'?`<div class="toast-spinner"></div><span>${msg}</span>`:`<span>${msg}</span>`;
            document.getElementById('toast-container').appendChild(t);
            if(type==='loading') currentLoadingToast = t;
            else setTimeout(() => { t.style.animation='fadeOut 0.5s forwards'; setTimeout(()=>t.remove(),500); }, 3000);
        }

        function copyPermalink(id, event) {
            event.stopPropagation();
            const url = window.location.href.split('#')[0] + '#' + id;
            navigator.clipboard.writeText(url).then(() => {
                showToast("Link copied!", "success");
            }).catch(() => {
                showToast("Link: " + url, "info");
            });
        }

        // State Management
        let postsCache = []; 
        let interactionsCache = {}; 
        let globalAdminHash = null;
        let globalAuthToken = null; 
        let globalApiKey = null;
        let sessionPassword = null;
        
        let isAdminLoggedIn = false;
        let currentLoadingToast = null;
        let pendingPost = null;
        let currentLightboxPostId = null; 
        let currentMediaList = [];
        let currentMediaIndex = 0;

        // Upload State
        let isBatchUploading = false;
        let currentBatchResolve = null;
        let currentBatchReject = null;
        let currentPostMediaQueue = [];

        // Filter State
        let activeTagFilter = null;
        let activeSearchQuery = "";
        
        let currentConfig = {
            siteName: "LBM // System",
            metaTitle: "LBM System",
            metaDescription: "A personal microblogging archive.",
            tagline: "Personal Archive",
            leafletsName: "Leaflets",
            allowComments: true,
            copyright: "2025 LBM",
            bgImage: "",
            bannerImage: "",
            pfpImage: "",
            customCss: "",
            reactionsEnabled: true,
            reactionIcon: "face",
            likeLabel: "(Ôºæ‚àáÔºæ)",
            dislikeLabel: "(Ôºõ„Å∏Ôºö)",
            widgetPadding: "1.5rem",
            colors: { ...DEFAULT_THEME_COLORS }
        };

        // Initialization
        window.onload = async function() {
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,
                    gfm: true
                });
            }

            // Marquee Content Duplication
            const marquee = document.getElementById('marquee-content');
            if(marquee) {
                marquee.innerHTML += marquee.innerHTML;
            }

            loadFromLocalCache();
            window.addEventListener('message', handleBridgeMessage);
            
            if (window.location.protocol !== 'file:') {
                injectBridge(FIXED_BRIDGE_URL);
            }

            const timestamp = new Date().getTime();
            const loadScript = (src) => new Promise((resolve) => {
                const s = document.createElement('script');
                s.src = `${src}?v=${timestamp}`;
                s.onload = resolve;
                s.onerror = () => { console.log(`[LBM] Note: ${src} not found (fresh install?)`); resolve(); }; 
                document.body.appendChild(s);
            });

            await Promise.all([loadScript('system.js'), loadScript('interactions.js')]);
            parseSystemData();
        };

        function loadFromLocalCache() {
            try {
                const cached = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (cached) {
                    const localData = JSON.parse(cached);
                    currentConfig = { ...currentConfig, ...localData, colors: { ...currentConfig.colors, ...(localData.colors || {}) } };
                    applyVisualConfig();
                }
            } catch (e) { console.error("[LBM] LocalStorage Error", e); }
        }

        function saveToLocalCache() {
            try { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentConfig)); } catch(e) {}
        }

        function parseSystemData() {
            if (typeof window.AZUMINT_INTERACTIONS !== 'undefined') {
                try {
                    const iJson = base64ToUnicode(window.AZUMINT_INTERACTIONS);
                    interactionsCache = JSON.parse(iJson);
                } catch(e) { console.error("Interactions Parse Error", e); }
            }

            if (typeof window.AZUMINT_SYSTEM === 'undefined') {
                console.log("System file missing. Starting Setup.");
                showSetup();
            } else {
                try {
                    const jsonStr = base64ToUnicode(window.AZUMINT_SYSTEM);
                    const data = JSON.parse(jsonStr);
                    
                    globalAdminHash = data.adminHash;
                    postsCache = data.posts || [];
                    
                    if (data.authToken) globalAuthToken = data.authToken;
                    if (data.apiKey) globalApiKey = data.apiKey;
                    
                    if (data.siteConfig) {
                        currentConfig = { 
                            ...currentConfig, 
                            ...data.siteConfig, 
                            colors: {...currentConfig.colors, ...(data.siteConfig.colors || {})}
                        };
                        saveToLocalCache();
                    }
                    
                    applyVisualConfig();
                    renderLeaflets();
                    renderGallery();
                    renderTagCloud();
                    
                    // Permalink Handler
                    if(window.location.hash) {
                        const id = window.location.hash.substring(1);
                        const numericId = parseInt(id);
                        if (!isNaN(numericId)) {
                             openLightbox(numericId);
                        }
                        const el = document.getElementById(id);
                        if(el) {
                            setTimeout(() => {
                                el.scrollIntoView({behavior: 'smooth', block: 'center'});
                                el.classList.add('highlight-post');
                            }, 500);
                        }
                    }
                    
                    document.getElementById('db-status').innerText = "System Online";
                    document.getElementById('db-status').classList.add('online');
                } catch(e) {
                    console.error("Config Parse Error", e);
                    showToast("Error reading system.js.", "error");
                    showSetup();
                }
            }
        }

        // Bridge Communication
        let tokenizeResolve = null; 
        
        function handleBridgeMessage(e) {
            if (e.data.type === 'TOKEN_RESULT') {
                if(e.data.success && tokenizeResolve) {
                    tokenizeResolve(e.data.token);
                } else if (!e.data.success && tokenizeResolve) {
                    showToast("Token Generation Failed: " + e.data.message, "error");
                    tokenizeResolve(null);
                }
                tokenizeResolve = null;
            }

            if(e.data.type === 'UPLOAD_RESULT') {
                if (isBatchUploading) {
                    if (e.data.success) {
                        if (currentBatchResolve) currentBatchResolve(true);
                    } else {
                        if (currentBatchReject) currentBatchReject(e.data.message);
                    }
                    return; 
                }

                if (currentLoadingToast && currentLoadingToast.parentNode) currentLoadingToast.remove();
                
                if(e.data.success) {
                    hideUploadModal();
                    showToast("Sync Successful!", "success");
                    updateSyncStatus('synced', 'System Synced');
                } else {
                    if (e.data.message && (e.data.message.includes("Invalid or Corrupted Token") || e.data.message.includes("403") || e.data.message.includes("invalid credentials"))) {
                        hideUploadModal();
                        document.getElementById('repair-modal').style.display = 'flex';
                    } else {
                        handleUploadError(e.data.message);
                    }
                }
            }
        }

        // Token Repair
        async function runRepair() {
            const k = document.getElementById('repair-api-key').value;
            if(!k) return alert("Please enter API Key");
            
            showToast("Repairing Connection...", "loading");
            const cleanKey = k.trim();
            const newToken = await requestTokenGeneration(cleanKey, sessionPassword);
            
            if (newToken) {
                globalAuthToken = newToken;
                globalApiKey = null;
                pendingPost = null; 
                currentPostMediaQueue = [];
                
                document.getElementById('repair-modal').style.display = 'none';
                showToast("Repair Successful! Retrying Save...", "success");
                
                setTimeout(() => {
                    saveSystem(null, null, newToken); 
                }, 1000);
            } else {
                showToast("Repair Failed. Check Key.", "error");
            }
        }

        // Data Synchronization
        function injectBridge(url) {
            let frame = document.getElementById('bridge-frame');
            if(!frame) {
                frame = document.createElement('iframe');
                frame.id = 'bridge-frame';
                frame.style.display = 'none';
                document.body.appendChild(frame);
            }
            frame.src = url;
        }

        async function saveSystem(mediaFile = null, explicitMediaPath = null, overrideToken = null) {
            if(isAdminLoggedIn && document.getElementById('admin-dashboard').style.display === 'block') {
                scrapeConfig('edit');
            }
            saveToLocalCache();

            if (!globalAuthToken && !overrideToken && window.location.protocol === 'file:') {
                 showToast("Downloading System.js (Local Mode)", "success");
                 await generateConfigFile('edit');
                 return;
            }

            uploadToBridge('system', mediaFile, explicitMediaPath, overrideToken);

            if(!mediaFile) {
                setTimeout(() => uploadToBridge('rss', null, null, overrideToken), 3000);
            }
        }
        
        async function saveInteractions() { 
            if(!globalAuthToken && window.location.protocol === 'file:') return;
            uploadToBridge('interactions'); 
        }

        function forceSyncAll() { 
            saveToLocalCache();
            uploadToBridge('system'); 
            setTimeout(() => uploadToBridge('interactions'), 2000); 
            setTimeout(() => uploadToBridge('rss'), 4000); 
        }

        async function uploadToBridge(target, mediaFile = null, explicitMediaPath = null, overrideToken = null) {
            const tokenToSend = overrideToken || globalAuthToken;

            if(!tokenToSend) {
                showToast("No Auth Token found. Setup required.", "error");
                markUnsynced();
                return;
            }

            let passwordCheck = null;
            
            if (target === 'system' || target === 'media_only' || target === 'rss') {
                if (!sessionPassword) {
                     sessionPassword = document.getElementById('login-pass').value;
                }
                if (!sessionPassword) {
                    showToast("Session Expired. Re-login required.", "error");
                    return;
                }
                passwordCheck = sessionPassword;
            }

            let fileContent = "";
            let fileName = "";
            let mediaName = null;

            if (target === 'system') {
                const data = await prepareSystemData('edit', tokenToSend);
                const encodedStr = unicodeToBase64(JSON.stringify(data));
                fileContent = `window.AZUMINT_SYSTEM = "${encodedStr}";`;
                fileName = "system.js";
            } else if (target === 'interactions') {
                const encodedStr = unicodeToBase64(JSON.stringify(interactionsCache));
                fileContent = `window.AZUMINT_INTERACTIONS = "${encodedStr}";`;
                fileName = "interactions.js";
                showToast("Syncing Interactions...", "loading");
            } else if (target === 'rss') {
                fileContent = generateRSS();
                fileName = "rss.xml";
                showToast("Updating RSS Feed...", "loading");
            }

            if (mediaFile) {
                const rawName = explicitMediaPath || document.getElementById('admin-media').value;
                mediaName = (rawName && rawName.indexOf('/') === -1) ? 'img/' + rawName : rawName;
            }

            if (!isBatchUploading && (target === 'system' || target === 'media_only')) {
                showToast(mediaFile ? "Uploading Media..." : "Saving System...", "loading");
                showUploadModal(mediaFile ? "Uploading Media..." : "Saving System...");
            }

            const frame = document.getElementById('bridge-frame');
            if(frame) {
                frame.contentWindow.postMessage({
                    type: 'UPLOAD', 
                    authToken: tokenToSend, 
                    passwordCheck: passwordCheck, 
                    fileContent: fileContent, 
                    filename: fileName, 
                    mediaFile: mediaFile, 
                    mediaName: mediaName
                }, FIXED_BRIDGE_URL); 
            } else {
                showToast("Bridge disconnected.", "error");
            }
        }

        // Batch Upload Helper
        function promisifiedUpload(mediaFile, path) {
            return new Promise((resolve, reject) => {
                currentBatchResolve = resolve;
                currentBatchReject = reject;
                uploadToBridge('media_only', mediaFile, path);
            });
        }

        // Data Payload Construction
        async function prepareSystemData(mode, explicitToken = null) {
            let hashVar, tokenToSave = explicitToken || globalAuthToken;

            if (mode === 'setup') {
                const pass = document.getElementById('setup-password').value;
                const rawKey = document.getElementById('setup-neocities-key').value;
                
                if (!pass || !rawKey) { showToast("Credentials missing.", "error"); return null; }

                showToast("Encrypting Credentials...", "loading");
                tokenToSave = await requestTokenGeneration(rawKey, pass);
                
                if (!tokenToSave) return null; 
                
                scrapeConfig('setup');
                hashVar = await sha256(pass);
            } else {
                if(isAdminLoggedIn) {
                    if(document.getElementById('admin-dashboard').style.display === 'block') {
                        scrapeConfig('edit');
                    }
                }
                hashVar = globalAdminHash;
                
                const newKeyInput = document.getElementById('edit-neocities-key').value;
                if (newKeyInput && newKeyInput.length > 5) {
                    showToast("Rotating Security Token...", "loading");
                    const t = await requestTokenGeneration(newKeyInput, sessionPassword);
                    if (t) {
                        tokenToSave = t;
                        globalAuthToken = t;
                    }
                }
            }

            if (explicitToken) tokenToSave = explicitToken;

            let keyToSave = (tokenToSave || globalAuthToken) ? null : globalApiKey;

            return {
                adminHash: hashVar,
                siteConfig: currentConfig,
                posts: postsCache,
                authToken: tokenToSave,
                apiKey: keyToSave
            };
        }

        function requestTokenGeneration(key, pass) {
            return new Promise((resolve) => {
                tokenizeResolve = resolve;
                const frame = document.getElementById('bridge-frame');
                if(!frame) { resolve(null); return; }
                frame.contentWindow.postMessage({
                    type: 'TOKENIZE',
                    rawKey: key,
                    adminPass: pass
                }, FIXED_BRIDGE_URL);
                
                setTimeout(() => { if(tokenizeResolve) { tokenizeResolve(null); } }, 10000);
            });
        }

        // UI Configuration Extraction
        function scrapeConfig(prefix) {
             const id = (name) => { const el = document.getElementById(prefix + '-' + name); return el ? el.value : ''; };
             const col = (name) => { const el = document.getElementById((prefix === 'edit' ? 'edit-col-' : 'col-') + name); return el ? el.value : '#000000'; };
             
             currentConfig.siteName = id('site-name');
             currentConfig.tagline = id('tagline');
             currentConfig.leafletsName = id('leaflets-name');
             currentConfig.copyright = id('copyright');
             
             if (prefix === 'edit') {
                 currentConfig.metaTitle = id('window-title') || currentConfig.siteName;
                 currentConfig.metaDescription = id('meta-desc') || "";
             }
             
             currentConfig.bgImage = id('bg-image');
             currentConfig.pfpImage = id('pfp-image');
             currentConfig.bannerImage = id('banner-image');
             currentConfig.customCss = id('custom-css');
             currentConfig.widgetPadding = id('widget-padding');
             
             const reactionsEnabledEl = document.getElementById((prefix === 'edit' ? 'edit-' : 'setup-') + 'reactions-enabled');
             currentConfig.reactionsEnabled = reactionsEnabledEl ? reactionsEnabledEl.value === 'true' : true;
             
             currentConfig.reactionIcon = id('reaction-icon');
             currentConfig.likeLabel = id('like-label');
             currentConfig.dislikeLabel = id('dislike-label');
             
             const commentsEl = document.getElementById((prefix === 'edit' ? 'edit-' : 'setup-') + 'comments');
             currentConfig.allowComments = commentsEl ? commentsEl.value === 'true' : true;

             currentConfig.colors.bg = col('bg');
             currentConfig.colors.text = col('text');
             currentConfig.colors.sidebar = col('sidebar');
             currentConfig.colors.accent = col('accent');
             currentConfig.colors.leaflet = col('leaflet');
             currentConfig.colors.border = col('border');
             currentConfig.colors.navActive = col('nav-active');
             currentConfig.colors.like = col('like');
             currentConfig.colors.dislike = col('dislike');
             currentConfig.colors.likeBtn = col('like-btn');
             currentConfig.colors.dislikeBtn = col('dislike-btn');
        }

        function applyVisualConfig() {
            if (currentConfig.metaTitle) document.title = currentConfig.metaTitle;
            else document.title = currentConfig.siteName;
            
            const metaDesc = document.getElementById('dynamic-desc');
            if (metaDesc && currentConfig.metaDescription) metaDesc.setAttribute('content', currentConfig.metaDescription);

            const setTxt = (id, txt) => { const el = document.getElementById(id); if(el) el.innerText = txt || ""; };
            setTxt('header-site-name', currentConfig.siteName);
            setTxt('header-tagline', currentConfig.tagline);
            setTxt('nav-leaflets-btn', currentConfig.leafletsName);
            setTxt('header-leaflets-title', "Recent " + currentConfig.leafletsName);
            const foot = document.getElementById('footer-text');
            if (foot) foot.innerHTML = "&copy; " + currentConfig.copyright;
    
            const r = document.documentElement.style;
            const c = currentConfig.colors;
            const setVar = (n, v) => r.setProperty(n, v);
            setVar('--background-color', c.bg); setVar('--text-color', c.text); setVar('--sidebar-bg', c.sidebar);
            setVar('--header-footer-color', c.sidebar); setVar('--accent-color', c.accent); setVar('--leaflet-bg', c.leaflet);
            setVar('--border-color', c.border); setVar('--nav-active-color', c.navActive); setVar('--like-color', c.like);
            setVar('--dislike-color', c.dislike); setVar('--like-btn-color', c.likeBtn); setVar('--dislike-btn-color', c.dislikeBtn);
            setVar('--widget-padding', currentConfig.widgetPadding);
            
            if(currentConfig.bgImage && currentConfig.bgImage.length > 5) setVar('--bg-image', `url('${currentConfig.bgImage}')`);
            else setVar('--bg-image', 'none');
    
            const pfpEl = document.getElementById('header-pfp');
            if (pfpEl) {
                if (currentConfig.pfpImage && currentConfig.pfpImage.length > 5) { pfpEl.src = currentConfig.pfpImage; pfpEl.style.display = 'block'; } 
                else { pfpEl.style.display = 'none'; }
            }
            const headerEl = document.getElementById('site-header-block');
            if (headerEl) {
                if (currentConfig.bannerImage && currentConfig.bannerImage.length > 5) headerEl.style.backgroundImage = `url('${currentConfig.bannerImage}')`;
                else headerEl.style.backgroundImage = 'none';
            }
    
            let customStyle = document.getElementById('custom-css-block');
            if (!customStyle) { customStyle = document.createElement('style'); customStyle.id = 'custom-css-block'; document.head.appendChild(customStyle); }
            customStyle.textContent = currentConfig.customCss || '';

            // Dynamic RSS Link Injection
            let rssLink = document.getElementById('dynamic-rss');
            if(!rssLink) {
                rssLink = document.createElement('link');
                rssLink.id = 'dynamic-rss';
                rssLink.rel = 'alternate';
                rssLink.type = 'application/rss+xml';
                rssLink.title = 'RSS Feed';
                rssLink.href = 'rss.xml';
                document.head.appendChild(rssLink);
            }
        }
        
        function updateSetupPreview() { scrapeConfig('setup'); applyVisualConfig(); }
        function updateLivePreview() { scrapeConfig('edit'); applyVisualConfig(); markUnsynced(); }
        
        function resetColors() {
            if(!confirm("Reset all colors to the default theme?")) return;
            currentConfig.colors = { ...DEFAULT_THEME_COLORS }; 
            populateAdminFields(); 
            applyVisualConfig();   
            markUnsynced();
            showToast("Colors reset to default.", "success");
        }

        // Authentication
        async function adminLogin() {
            const passEl = document.getElementById('login-pass');
            if(!globalAdminHash) return showToast("Config missing.", "error");
            
            const rawPassword = passEl.value;
            const inputHash = await sha256(rawPassword);
            
            if(inputHash === globalAdminHash) {
                isAdminLoggedIn = true;
                sessionPassword = rawPassword; 
                
                // Auto-Migration Check
                if (globalApiKey && !globalAuthToken) {
                    showToast("Upgrading Security to v0.4...", "loading");
                    
                    const newToken = await requestTokenGeneration(globalApiKey, rawPassword);
                    if (newToken) {
                        globalAuthToken = newToken;
                        globalApiKey = null; 
                        await saveSystem();
                        showToast("Security Upgrade Complete!", "success");
                    } else {
                        showToast("Security Upgrade Failed. Check Bridge.", "error");
                    }
                }
                
                document.getElementById('admin-login-form').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'block';
                populateAdminFields();
                renderLeaflets(); 
            } else {
                showToast("Incorrect Password", "error");
            }
        }

        function populateAdminFields() {
            const id = (n) => document.getElementById('edit-' + n);
            const col = (n) => document.getElementById('edit-col-' + n);
            
            id('site-name').value = currentConfig.siteName;
            id('tagline').value = currentConfig.tagline;
            id('leaflets-name').value = currentConfig.leafletsName;
            id('copyright').value = currentConfig.copyright;
            id('window-title').value = currentConfig.metaTitle || "";
            id('meta-desc').value = currentConfig.metaDescription || "";
            
            id('bg-image').value = currentConfig.bgImage;
            id('pfp-image').value = currentConfig.pfpImage;
            id('banner-image').value = currentConfig.bannerImage;
            id('custom-css').value = currentConfig.customCss;
            id('widget-padding').value = currentConfig.widgetPadding;
            
            id('reactions-enabled').value = currentConfig.reactionsEnabled;
            id('reaction-icon').value = currentConfig.reactionIcon;
            id('like-label').value = currentConfig.likeLabel;
            id('dislike-label').value = currentConfig.dislikeLabel;
            id('comments').value = currentConfig.allowComments;

            col('bg').value = currentConfig.colors.bg; col('text').value = currentConfig.colors.text;
            col('sidebar').value = currentConfig.colors.sidebar; col('accent').value = currentConfig.colors.accent;
            col('leaflet').value = currentConfig.colors.leaflet; col('border').value = currentConfig.colors.border;
            col('nav-active').value = currentConfig.colors.navActive;
            col('like').value = currentConfig.colors.like;
            col('dislike').value = currentConfig.colors.dislike;
            col('like-btn').value = currentConfig.colors.likeBtn;
            col('dislike-btn').value = currentConfig.colors.dislikeBtn;
        }

        // Post Management
        async function addPost() {
            const content = document.getElementById('admin-content').value;
            const tagsInput = document.getElementById('admin-tags').value;
            const pinned = document.getElementById('admin-pin').checked;
            
            if (!content) return showToast("Content required", "error");
            
            const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t.length > 0);
            const isLocal = window.location.protocol === 'file:' && !globalAuthToken;

            // Media Processing via Queue
            let finalMedia = [];
            const filesToUpload = currentPostMediaQueue.filter(item => item.type === 'file');

            if (filesToUpload.length > 0 && !isLocal) {
                showUploadModal("Initializing Batch Upload...");
                isBatchUploading = true;
                
                try {
                    for (let i = 0; i < filesToUpload.length; i++) {
                        const file = filesToUpload[i].val;
                        const count = i + 1;
                        const total = filesToUpload.length;
                        
                        document.getElementById('upload-status-text').innerText = `Uploading image ${count}/${total}: ${file.name}`;
                        
                        // We use the file name as the destination path logic
                        const path = 'img/' + file.name;
                        await promisifiedUpload(file, path);
                    }
                } catch(err) {
                    handleUploadError("Batch Upload Failed: " + err);
                    isBatchUploading = false;
                    return; 
                }
                isBatchUploading = false; 
            }

            // Construct Final Media List based on Queue Order
            currentPostMediaQueue.forEach(item => {
                if (item.type === 'file') {
                    finalMedia.push('img/' + item.val.name);
                } else if (item.type === 'url') {
                    finalMedia.push(item.val);
                }
            });

            let savedMedia = finalMedia.length > 0 ? finalMedia : ""; 
            if(finalMedia.length === 1) savedMedia = finalMedia[0];

            const newPost = { id: Date.now(), date: new Date().toISOString().slice(0, 16).replace('T', ' '), content: content, media: savedMedia, tags: tags, pinned: pinned };
            
            postsCache.push(newPost);
            
            if (filesToUpload.length > 0 && isLocal) {
                 alert("Local Mode: You must manually move your files to 'img/' folder.");
            }
            
            showUploadModal("Finalizing Post...");
            saveSystem(); 
            
            clearPostInputs();
            renderLeaflets();
            renderTagCloud();
        }

        function deletePost(postId, event) {
            event.stopPropagation();
            if (!confirm("Delete post?")) return;
            postsCache = postsCache.filter(p => p.id !== postId);
            renderLeaflets();
            renderTagCloud();
            saveSystem(); 
        }

        function openEditModal(postId, event) {
            if (event) event.stopPropagation();
            const post = postsCache.find(p => p.id === postId);
            if (!post) return;

            document.getElementById('edit-post-id').value = post.id;
            document.getElementById('edit-post-content').value = post.content;
            document.getElementById('edit-post-tags').value = (post.tags || []).join(', ');
            document.getElementById('edit-post-pin').checked = post.pinned || false;

            // Populate Queue
            currentPostMediaQueue = [];
            if (post.media) {
                let arr = Array.isArray(post.media) ? post.media : [post.media];
                arr.forEach(url => {
                    if(url.trim().length > 0) currentPostMediaQueue.push({ type: 'url', val: url.trim() });
                });
            }
            renderMediaQueue('edit');

            document.getElementById('edit-overlay').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('edit-overlay').style.display = 'none';
            currentPostMediaQueue = []; // Clear
        }

        function submitEditedPost() {
            const id = parseInt(document.getElementById('edit-post-id').value);
            const content = document.getElementById('edit-post-content').value;
            const tagsInput = document.getElementById('edit-post-tags').value;
            const pinned = document.getElementById('edit-post-pin').checked;

            if (!content) return showToast("Content required", "error");

            const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t.length > 0);
            
            // Construct Media from Queue
            let media = currentPostMediaQueue.map(item => item.val);
            if(media.length === 0) media = "";
            else if(media.length === 1) media = media[0];

            const idx = postsCache.findIndex(p => p.id === id);
            if (idx !== -1) {
                postsCache[idx].content = content;
                postsCache[idx].media = media;
                postsCache[idx].tags = tags;
                postsCache[idx].pinned = pinned;
                
                saveSystem();
                closeEditModal();
                renderLeaflets();
                renderTagCloud();
                showToast("Post updated.", "success");
            }
        }

        function togglePin(postId, event) {
            event.stopPropagation();
            const post = postsCache.find(p => p.id === postId);
            if(post) {
                post.pinned = !post.pinned;
                renderLeaflets();
                saveSystem();
            }
        }

        // Filter Logic
        function handleSearch(val) {
            activeSearchQuery = val.trim().toLowerCase();
            renderLeaflets();
        }

        function filterByTag(tag) {
            if (activeTagFilter === tag) {
                activeTagFilter = null; 
            } else {
                activeTagFilter = tag;
            }
            renderLeaflets();
            toggleMobileMenu(false); 
        }

        function clearFilters() {
            activeTagFilter = null;
            activeSearchQuery = "";
            document.getElementById('search-input').value = "";
            renderLeaflets();
        }

        function toggleMobileMenu(forceState) {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (forceState === false) {
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
            } else {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('open');
            }
        }

        // Render Logic
        function renderLeaflets() {
            const container = document.getElementById('leaflets-container');
            const title = document.getElementById('header-leaflets-title');
            const clrBtn = document.getElementById('clear-filter-btn');
            const sortMode = document.getElementById('sort-filter').value;

            let posts = [...postsCache];

            posts.sort((a, b) => {
                if (sortMode === 'newest') return b.id - a.id;
                if (sortMode === 'oldest') return a.id - b.id;
                if (sortMode === 'popular') {
                    const likesA = (interactionsCache[a.id]?.likes || 0);
                    const likesB = (interactionsCache[b.id]?.likes || 0);
                    return likesB - likesA;
                }
                if (sortMode === 'controversial') {
                    const dislikesA = (interactionsCache[a.id]?.dislikes || 0);
                    const dislikesB = (interactionsCache[b.id]?.dislikes || 0);
                    return dislikesB - dislikesA;
                }
                return b.id - a.id;
            });

            posts.sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return 0; 
            });

            if (activeSearchQuery || activeTagFilter) {
                posts = posts.filter(p => {
                    const contentLower = p.content.toLowerCase();
                    const matchesSearch = !activeSearchQuery || contentLower.includes(activeSearchQuery);
                    
                    const postTags = p.tags || [];
                    const matchesTag = !activeTagFilter || postTags.includes(activeTagFilter);
                    
                    return matchesSearch && matchesTag;
                });

                let status = "Found";
                if(activeTagFilter) status = `Tag: //${activeTagFilter}`;
                if(activeSearchQuery) status += ` searching "${activeSearchQuery}"`;
                title.innerText = status;
                clrBtn.style.display = 'inline-block';
            } else {
                title.innerText = "Recent " + currentConfig.leafletsName;
                clrBtn.style.display = 'none';
            }

            if(posts.length === 0) { container.innerHTML = `<p style="font-family:var(--font-mono); color:var(--gray);">No matching content.</p>`; return; }
            
            let userReactions = {};
            try {
                userReactions = JSON.parse(localStorage.getItem(LOCAL_REACTIONS_KEY) || '{}');
            } catch(e) {}

            container.innerHTML = posts.map(post => {
                const ints = interactionsCache[post.id] || { likes: 0, dislikes: 0 };
                const total = (ints.likes || 0) + (ints.dislikes || 0);
                const ratio = total === 0 ? 50 : (ints.likes / total) * 100;
                
                // Multi-Image Display
                let mediaHtml = '';
                if (post.media) {
                    let mediaArray = Array.isArray(post.media) ? post.media : [post.media];
                    if (mediaArray.length > 0) {
                        const firstItem = mediaArray[0];
                        const type = getMediaType(firstItem);
                        const countBadge = mediaArray.length > 1 ? `<div class="media-count-badge">+${mediaArray.length - 1}</div>` : '';
                        
                        if (type === 'video') {
                             mediaHtml = `<div class="leaflet-media-container"><video controls loop muted playsinline onclick="event.stopPropagation(); openMediaViewer('${firstItem}', 'video')"><source src="${firstItem}" type="video/mp4"></video>${countBadge}</div>`;
                        } else {
                             mediaHtml = `<div class="leaflet-media-container" onclick="event.stopPropagation(); openLightbox(${post.id})"><img src="${firstItem}" alt="Media" onerror="this.style.display='none'">${countBadge}</div>`;
                        }
                    }
                }
                
                const contentHtml = typeof marked !== 'undefined' ? marked.parse(post.content) : post.content;
                const avatar = (currentConfig.pfpImage && currentConfig.pfpImage.length > 5) ? `<img src="${currentConfig.pfpImage}" style="width:100%; height:100%; object-fit:cover;">` : 'üåø';
                const authorName = currentConfig.siteName || "Admin";

                let reactions = '';
                if (currentConfig.reactionsEnabled) {
                    let [lTxt, dTxt] = [currentConfig.likeLabel || '(Ôºæ‚àáÔºæ)', currentConfig.dislikeLabel || '(Ôºõ„Å∏Ôºö)'];
                    if(currentConfig.reactionIcon === 'thumb') [lTxt, dTxt] = ['üëç', 'üëé'];
                    if(currentConfig.reactionIcon === 'arrow') [lTxt, dTxt] = ['‚ñ≤', '‚ñº'];
                    
                    const myAction = userReactions[post.id];
                    const likeActive = myAction === 'like' ? 'active-reaction' : '';
                    const dislikeActive = myAction === 'dislike' ? 'active-reaction' : '';

                    reactions = `
                    <div class="reaction-widget" onclick="event.stopPropagation()">
                        <button class="reaction-btn like-btn ${likeActive}" onclick="handleReaction(${post.id}, 'like')">${ints.likes || 0} ${lTxt}</button>
                        <div class="reaction-bar"><div class="reaction-fill" style="width: ${ratio}%"></div></div>
                        <button class="reaction-btn dislike-btn ${dislikeActive}" onclick="handleReaction(${post.id}, 'dislike')">${dTxt} ${ints.dislikes || 0}</button>
                    </div>`;
                }
                
                const tagsHtml = (post.tags && post.tags.length > 0) 
                    ? `<div style="margin-top:10px;">${post.tags.map(t => `<span class="tag-link" onclick="event.stopPropagation(); filterByTag('${t}')">//${t}</span>`).join(' ')}</div>` 
                    : '';

                const delBtn = isAdminLoggedIn ? `<button class="delete-btn" onclick="deletePost(${post.id}, event)">[x] Delete</button>` : '';
                const editBtn = isAdminLoggedIn ? `<button class="pin-btn" onclick="openEditModal(${post.id}, event)">[Edit]</button>` : '';
                const pinToggle = isAdminLoggedIn ? `<button class="pin-btn" onclick="togglePin(${post.id}, event)">${post.pinned ? '[Unpin]' : '[Pin]'}</button>` : '';
                const shareBtn = `<button class="pin-btn" onclick="copyPermalink(${post.id}, event)" title="Link to this post" style="margin-left:auto;">#</button>`;
                
                const pinIcon = post.pinned ? '<span style="color:var(--accent-color);margin-right:5px;">üìå</span>' : '';

                return `
                <article class="leaflet-item ${post.pinned ? 'pinned-post' : ''}" id="${post.id}" onclick="openLightbox(${post.id})">
                    <div class="leaflet-avatar">${avatar}</div>
                    <div class="leaflet-body">
                        <div class="leaflet-header">${pinIcon}<span class="leaflet-author">${authorName}</span><span>${post.date}</span>${shareBtn}${editBtn}${pinToggle}${delBtn}</div>
                        <div class="leaflet-content"><div class="text-content-wrapper" id="content-${post.id}">${contentHtml}</div>${mediaHtml}</div>
                        ${tagsHtml}
                        ${reactions}
                    </div>
                </article>`;
            }).join('');

            setTimeout(() => {
                posts.forEach(post => {
                    const el = document.getElementById(`content-${post.id}`);
                    if(el && el.scrollHeight > 250) {
                        el.innerHTML += `
                        <div class="read-more-overlay" id="overlay-${post.id}">
                            <button class="read-more-btn" onclick="event.stopPropagation(); toggleContent(${post.id})">+ Show More</button>
                        </div>`;
                    } else if (el) {
                        el.style.maxHeight = 'none'; 
                    }
                });
            }, 0);
        }

        function toggleContent(id) {
            const el = document.getElementById(`content-${id}`);
            const overlay = document.getElementById(`overlay-${id}`);
            if(el) el.classList.add('expanded');
            if(overlay) overlay.style.display = 'none';
        }

        function renderGallery() {
            const container = document.getElementById('gallery-container');
            const items = [...postsCache].sort((a,b) => b.id - a.id).filter(p => p.media && p.media.length > 0);
            
            if(items.length === 0) { container.innerHTML = "<p style='font-family:var(--font-mono);color:var(--gray);'>No images.</p>"; return; }
            
            let flatMedia = [];
            items.forEach(post => {
                let arr = Array.isArray(post.media) ? post.media : [post.media];
                arr.forEach(m => flatMedia.push({url: m, id: post.id}));
            });

            container.innerHTML = flatMedia.map(item => {
                const type = getMediaType(item.url);
                const el = type === 'video' ? `<video src="${item.url}" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>` : `<img src="${item.url}" loading="lazy">`;
                return `<div class="gallery-item" onclick="event.stopPropagation(); openMediaViewer('${item.url}', '${type}')">${el}</div>`;
            }).join('');
        }

        function renderTagCloud() {
            const container = document.getElementById('tag-cloud-container');
            if(!container) return;
            
            const allTags = new Set();
            postsCache.forEach(p => {
                if(p.tags) p.tags.forEach(t => allTags.add(t));
            });
            
            if(allTags.size === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = '<div style="margin:10px 0; border-top:1px dotted var(--border-color); padding-top:10px; font-size:11px; color:var(--gray); font-family:var(--font-mono);">TAGS</div>' + 
                Array.from(allTags).sort().map(tag => {
                    const activeClass = (activeTagFilter === tag) ? 'active' : '';
                    return `<button class="tag-cloud-item ${activeClass}" onclick="filterByTag('${tag}')">//${tag}</button>`;
                }).join('');
        }

        // User Interaction
        function handleReaction(postId, type) {
            if(!interactionsCache[postId]) interactionsCache[postId] = { likes: 0, dislikes: 0, comments: [] };
            
            let userReactions = {};
            try { userReactions = JSON.parse(localStorage.getItem(LOCAL_REACTIONS_KEY) || '{}'); } catch(e) {}
            
            const currentAction = userReactions[postId];
            
            if (currentAction === type) {
                interactionsCache[postId][type + 's'] = Math.max(0, (interactionsCache[postId][type + 's'] || 0) - 1);
                delete userReactions[postId];
                showToast("Vote removed.", "info");
            } else {
                if (currentAction) {
                    interactionsCache[postId][currentAction + 's'] = Math.max(0, (interactionsCache[postId][currentAction + 's'] || 0) - 1);
                }
                interactionsCache[postId][type + 's'] = (interactionsCache[postId][type + 's'] || 0) + 1;
                userReactions[postId] = type;
                showToast("Vote recorded!", "success");
            }
            
            localStorage.setItem(LOCAL_REACTIONS_KEY, JSON.stringify(userReactions));
            renderLeaflets();
            if(currentLightboxPostId === postId) openLightbox(postId); 
            saveInteractions();
        }

        function openLightbox(postId) {
            const post = postsCache.find(p => p.id === postId);
            if(!post) return;
            currentLightboxPostId = postId;
            
            const body = document.getElementById('lightbox-body');
            const ints = interactionsCache[postId] || { comments: [] };
            const comments = ints.comments || [];
            const likes = ints.likes || 0;
            const dislikes = ints.dislikes || 0;
            
            let userReactions = {};
            try { userReactions = JSON.parse(localStorage.getItem(LOCAL_REACTIONS_KEY) || '{}'); } catch(e) {}
            const myAction = userReactions[postId];
            const likeActive = myAction === 'like' ? 'active' : '';
            const dislikeActive = myAction === 'dislike' ? 'active' : '';
            
            const total = likes + dislikes;
            const ratio = total === 0 ? 50 : (likes / total) * 100;

            let [lTxt, dTxt] = [currentConfig.likeLabel || '(Ôºæ‚àáÔºæ)', currentConfig.dislikeLabel || '(Ôºõ„Å∏Ôºö)'];
            if(currentConfig.reactionIcon === 'thumb') [lTxt, dTxt] = ['üëç', 'üëé'];
            if(currentConfig.reactionIcon === 'arrow') [lTxt, dTxt] = ['‚ñ≤', '‚ñº'];

            let mediaHtml = '';
            if (post.media) {
                 let mediaArray = Array.isArray(post.media) ? post.media : [post.media];
                 mediaHtml = mediaArray.map(url => {
                     const type = getMediaType(url);
                     if (type === 'video') return `<div class="leaflet-media-container"><video controls autoplay loop muted playsinline style="width:100%" onclick="openMediaViewer('${url}', 'video')"><source src="${url}" type="video/mp4"></video></div>`;
                     else return `<div class="leaflet-media-container"><img src="${url}" alt="Attached Media" onclick="openMediaViewer('${url}', 'image')" onerror="this.style.display='none'"></div>`;
                 }).join('');
            }
            
            const contentHtml = typeof marked !== 'undefined' ? marked.parse(post.content) : post.content;
            
            const avatar = (currentConfig.pfpImage && currentConfig.pfpImage.length > 5) ? `<img src="${currentConfig.pfpImage}" style="width:100%; height:100%; object-fit:cover;">` : 'üåø';
            const authorName = currentConfig.siteName || "Admin";

            let commentsHtml = '';
            if (currentConfig.allowComments) {
                const renderTree = (pid, d) => {
                    const kids = comments.filter(c => c.parentId === pid);
                    if(!kids.length) return '';
                    return `<ul class="${d?'reply-list':'comments-list'}">` + kids.map(c => {
                        const initial = c.author ? c.author.charAt(0).toUpperCase() : '?';
                        const adminClass = c.isAdmin ? 'admin-comment' : '';
                        const adminBadge = c.isAdmin ? '<span class="admin-badge">ADMIN</span>' : '';
                        
                        return `
                        <li class="comment-item ${adminClass}">
                            <div class="comment-inner">
                                <div class="comment-avatar">${initial}</div>
                                <div class="comment-body">
                                    <div class="comment-header">
                                        <span class="comment-author">${c.author} ${adminBadge}</span>
                                        <span>${c.date}</span>
                                        ${isAdminLoggedIn ? `<button class="delete-btn" style="float:right;" onclick="deleteComment(${postId}, ${c.id})">[x]</button>` : ''}
                                    </div>
                                    <div>${c.text}</div>
                                    <button class="reply-btn" onclick="document.getElementById('comment-parent-id').value=${c.id};document.getElementById('reply-display').style.display='block';document.getElementById('reply-name').innerText='${c.author}'">Reply</button>
                                </div>
                            </div>
                            ${renderTree(c.id, d+1)}
                        </li>`;
                    }).join('') + `</ul>`;
                };
                
                const defaultName = isAdminLoggedIn ? (currentConfig.siteName || "Admin") : "";
                
                commentsHtml = `
                <div class="comments-section">
                    <div class="lightbox-comment-form">
                        <input type="text" id="comment-author" placeholder="Name" value="${defaultName}">
                        <input type="hidden" id="comment-parent-id">
                        <div id="reply-display" style="display:none;font-size:11px;color:var(--accent-color);font-family:var(--font-mono);margin-bottom:5px;">Replying to <span id="reply-name"></span> <button onclick="this.parentNode.style.display='none';document.getElementById('comment-parent-id').value=''">x</button></div>
                        <textarea id="comment-text" placeholder="Write your reply..."></textarea>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <button class="action-btn" style="width:auto;" onclick="submitComment(${postId})">Reply</button>
                            <span class="form-footer-text">Please be respectful.</span>
                        </div>
                    </div>
                    <div id="comments-container" class="lightbox-comments-list">${renderTree(null, 0)}</div>
                </div>`;
            }

            const tagsHtml = (post.tags && post.tags.length > 0) 
                    ? `<div style="margin-top:10px;">${post.tags.map(t => `<span class="tag-link" onclick="event.stopPropagation(); filterByTag('${t}'); closeLightbox();">//${t}</span>`).join(' ')}</div>` 
                    : '';
            
            const pinIcon = post.pinned ? '<span style="color:var(--accent-color);margin-right:5px;">üìå</span>' : '';

            body.innerHTML = `
                <div class="leaflet-item" style="cursor:default; border:none; background:transparent; border-radius:0; box-shadow:none;">
                    <div class="leaflet-avatar">${avatar}</div>
                    <div class="leaflet-body">
                        <div class="leaflet-header">${pinIcon}<span class="leaflet-author">${authorName}</span><span>${post.date}</span></div>
                        <div class="leaflet-content"><div>${contentHtml}</div>${mediaHtml}</div>
                        ${tagsHtml}
                    </div>
                </div>
                
                <div class="lightbox-stats" style="align-items:center;">
                    <div class="lightbox-stat-item" style="color:var(--like-color); white-space:nowrap;"><b>${likes}</b> ${lTxt}</div>
                    <div class="reaction-bar" style="margin:0 15px; height:4px; flex:1; background:var(--border-color); border-radius:2px; overflow:hidden;">
                        <div class="reaction-fill" style="width: ${ratio}%; height:100%; background: linear-gradient(90deg, var(--like-color), var(--accent-color)); transition:width 0.3s;"></div>
                    </div>
                    <div class="lightbox-stat-item" style="color:var(--dislike-color); white-space:nowrap;"><b>${dislikes}</b> ${dTxt}</div>
                    <div class="lightbox-stat-item" style="margin-left:15px; padding-left:15px; border-left:1px solid var(--border-color); white-space:nowrap;"><b>${comments.length}</b> Comments</div>
                </div>

                <div class="lightbox-actions">
                    <button class="lightbox-action-btn ${likeActive}" onclick="handleReaction(${postId}, 'like')">${lTxt}</button>
                    <button class="lightbox-action-btn ${dislikeActive}" onclick="handleReaction(${postId}, 'dislike')">${dTxt}</button>
                </div>

                ${commentsHtml}`;
            
            document.getElementById('leaflet-lightbox').classList.add('open');
            document.body.classList.add('modal-open');
        }

        function submitComment(postId) {
            const author = document.getElementById('comment-author').value || "Guest";
            const text = document.getElementById('comment-text').value;
            if(!text) return;
            const pidVal = document.getElementById('comment-parent-id').value;
            
            if(!interactionsCache[postId]) interactionsCache[postId] = { likes: 0, dislikes: 0, comments: [] };
            if(!interactionsCache[postId].comments) interactionsCache[postId].comments = [];
            
            interactionsCache[postId].comments.push({ 
                id: Date.now(), 
                author, 
                text, 
                date: new Date().toISOString().slice(0,16).replace('T',' '), 
                parentId: pidVal ? parseInt(pidVal) : null,
                isAdmin: isAdminLoggedIn
            });
            openLightbox(postId); 
            saveInteractions();
        }

        function deleteComment(postId, cid) {
            if(confirm("Delete?")) {
                interactionsCache[postId].comments = interactionsCache[postId].comments.filter(c => c.id !== cid);
                openLightbox(postId);
                saveInteractions();
            }
        }

        // Export Utilities
        async function generateConfigFile(mode) {
            const data = await prepareSystemData(mode);
            if(!data) return;
            const content = `window.AZUMINT_SYSTEM = "${unicodeToBase64(JSON.stringify(data))}";`;
            downloadFile(content, "system.js");
        }
        
        function downloadStaticIndex() {
            applyVisualConfig();
            const clone = document.documentElement.cloneNode(true);
            const html = "<!DOCTYPE html>\n" + clone.outerHTML;
            downloadFile(html, "index.html");
        }
        
        // RSS Feed Generator
        function generateRSS() {
            const siteUrl = window.location.origin + window.location.pathname.replace('index.html', '');
            const now = new Date().toUTCString();
            
            let items = [...postsCache].sort((a,b) => b.id - a.id).map(post => {
                const link = `${siteUrl}#${post.id}`;
                let desc = post.content;
                
                let arr = Array.isArray(post.media) ? post.media : (post.media ? [post.media] : []);
                if(arr.length > 0) desc += ` <br><a href="${arr[0]}">[Attached Media]</a>`;
                
                return `
                <item>
                    <title>${post.date}</title>
                    <link>${link}</link>
                    <guid>${link}</guid>
                    <pubDate>${new Date(post.id).toUTCString()}</pubDate>
                    <description><![CDATA[${desc}]]></description>
                </item>`;
            }).join('');

            const rss = `<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0">
<channel>
  <title>${currentConfig.siteName}</title>
  <link>${siteUrl}</link>
  <description>${currentConfig.tagline}</description>
  <lastBuildDate>${now}</lastBuildDate>
  <generator>LBM 0.5</generator>
  ${items}
</channel>
</rss>`;
            return rss;
        }

        function downloadRSS() {
            const rssContent = generateRSS();
            downloadFile(rssContent, "rss.xml");
        }

        // UI Helpers
        function showSetup() { document.getElementById('setup-overlay').style.display = 'flex'; document.title = "System Setup"; }
        function hideUploadModal() { const m = document.getElementById('upload-modal'); if(m) m.style.display='none'; document.getElementById('upload-progress-bar').style.width='0%'; }
        function showUploadModal(txt) { document.getElementById('upload-modal').style.display='flex'; document.getElementById('upload-status-text').innerText=txt; document.getElementById('upload-error-log').style.display='none'; document.getElementById('upload-close-btn').style.display='none'; }
        function handleUploadError(msg) { document.getElementById('upload-status-text').innerText="FAILED"; document.getElementById('upload-status-text').style.color="#ff7675"; document.getElementById('upload-error-log').innerText=msg; document.getElementById('upload-error-log').style.display='block'; document.getElementById('upload-close-btn').style.display='inline-block'; }
        
        function updateSyncStatus(s,t) { const d=document.getElementById('sync-dot'); if(d) d.className='sync-indicator '+s; const tx=document.getElementById('sync-text'); if(tx) tx.innerText=t; }
        function markUnsynced() { updateSyncStatus('unsynced', 'Unsaved Changes'); }
        
        function handleFileSelect() { 
            const files = document.getElementById('file-selector').files; 
            if(files.length > 0) { 
                for(let i=0; i<files.length; i++) {
                    currentPostMediaQueue.push({ type: 'file', val: files[i] });
                }
                renderMediaQueue('admin');
                document.getElementById('file-selector').value = ''; // Reset to allow adding more
            } 
        }
        
        function addUrlToQueue(mode) {
            const inputId = mode === 'admin' ? 'admin-media-input' : 'edit-add-media-input';
            const val = document.getElementById(inputId).value.trim();
            if(val) {
                currentPostMediaQueue.push({ type: 'url', val: val });
                renderMediaQueue(mode);
                document.getElementById(inputId).value = '';
            }
        }

        function renderMediaQueue(mode) {
            const containerId = mode === 'admin' ? 'admin-media-queue' : 'edit-media-queue';
            const container = document.getElementById(containerId);
            if(!container) return;

            container.innerHTML = currentPostMediaQueue.map((item, idx) => {
                let prev = '';
                let name = '';
                
                if(item.type === 'file') {
                    name = item.val.name;
                    if(item.val.type.startsWith('image/')) {
                         prev = `<img src="${URL.createObjectURL(item.val)}" class="media-preview">`;
                    } else {
                         prev = `<div class="media-preview" style="background:#333; display:flex; align-items:center; justify-content:center;">FILE</div>`;
                    }
                } else {
                    name = item.val;
                    if(item.val.match(/\.(jpeg|jpg|gif|png)$/) != null) {
                         prev = `<img src="${item.val}" class="media-preview">`;
                    } else {
                         prev = `<div class="media-preview" style="background:#333; display:flex; align-items:center; justify-content:center;">URL</div>`;
                    }
                }

                return `
                <div class="media-queue-item">
                    ${prev}
                    <div class="media-info">${name}</div>
                    <div class="queue-controls">
                        <button class="queue-btn" onclick="moveQueueItem(${idx}, -1, '${mode}')">‚ñ≤</button>
                        <button class="queue-btn" onclick="moveQueueItem(${idx}, 1, '${mode}')">‚ñº</button>
                        <button class="queue-btn remove" onclick="removeQueueItem(${idx}, '${mode}')">√ó</button>
                    </div>
                </div>`;
            }).join('');
        }

        function moveQueueItem(idx, dir, mode) {
            if(idx + dir < 0 || idx + dir >= currentPostMediaQueue.length) return;
            const temp = currentPostMediaQueue[idx];
            currentPostMediaQueue[idx] = currentPostMediaQueue[idx+dir];
            currentPostMediaQueue[idx+dir] = temp;
            renderMediaQueue(mode);
        }

        function removeQueueItem(idx, mode) {
            currentPostMediaQueue.splice(idx, 1);
            renderMediaQueue(mode);
        }
        
        function clearPostInputs() { 
            document.getElementById('admin-content').value=''; 
            document.getElementById('admin-media').value=''; 
            document.getElementById('admin-tags').value=''; 
            document.getElementById('admin-pin').checked = false; 
            document.getElementById('file-selector').value=''; 
            document.getElementById('upload-file-info').style.display='none'; 
            currentPostMediaQueue = [];
            renderMediaQueue('admin');
        }
        
        function getMediaType(url) { 
            if(!url) return null; 
            const cleanUrl = url.split('?')[0];
            const ext = cleanUrl.split('.').pop().toLowerCase(); 
            return ['mp4','webm','ogg','mov'].includes(ext) ? 'video' : 'image'; 
        }
        
        function switchTab(t) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); if(t==='leaflets') document.getElementById('nav-leaflets-btn').classList.add('active'); if(t==='admin') document.getElementById('admin-tab-btn').classList.add('active'); }
        function switchAdminSubTab(t) { document.getElementById('admin-sub-post').style.display='none'; document.getElementById('admin-sub-settings').style.display='none'; document.getElementById('admin-sub-'+t).style.display='block'; }
        
        function openMediaViewer(url, type) { 
            currentMediaList = [];
            [...postsCache].sort((a,b) => b.id - a.id).forEach(p => {
                 let arr = Array.isArray(p.media) ? p.media : (p.media ? [p.media] : []);
                 arr.forEach(m => currentMediaList.push({url: m, type: getMediaType(m)}));
            });
            
            currentMediaIndex = currentMediaList.findIndex(m => m.url === url);
            if(currentMediaIndex === -1) { currentMediaList = [{url, type}]; currentMediaIndex = 0; }
            renderMediaOverlay();
            document.getElementById('media-fullscreen-overlay').classList.add('active');
            document.body.classList.add('modal-open'); 
        }

        function renderMediaOverlay() {
            const item = currentMediaList[currentMediaIndex];
            if(!item) return;
            const w = document.getElementById('media-content-wrapper');
            const btn = (dir, lbl) => `<button class="media-nav" onclick="event.stopPropagation(); navigateMedia(${dir})">${lbl}</button>`;
            const content = item.type === 'video' ? `<video controls autoplay loop style="max-width:80vw;max-height:90vh;box-shadow:0 0 20px rgba(0,0,0,0.5);"><source src="${item.url}"></video>` : `<img src="${item.url}" style="max-width:80vw;max-height:90vh;box-shadow:0 0 20px rgba(0,0,0,0.5);">`;
            w.innerHTML = btn(-1, '&lt;') + content + btn(1, '&gt;');
        }

        function navigateMedia(dir) {
            currentMediaIndex += dir;
            if(currentMediaIndex < 0) currentMediaIndex = currentMediaList.length - 1;
            if(currentMediaIndex >= currentMediaList.length) currentMediaIndex = 0;
            renderMediaOverlay();
        }

        function closeMediaViewer() { 
            document.getElementById('media-fullscreen-overlay').classList.remove('active'); 
            if(!currentLightboxPostId) document.body.classList.remove('modal-open'); 
            const v=document.querySelector('.media-overlay video'); 
            if(v) v.pause(); 
        }

        function closeLightbox() { document.getElementById('leaflet-lightbox').classList.remove('open'); document.body.classList.remove('modal-open'); currentLightboxPostId=null; }
    </script>
</body>
</html>